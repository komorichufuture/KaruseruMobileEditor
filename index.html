<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Page Editor</title>
<style>
  :root {
    --bg: #111827; --bg2: #1f2937; --bg3: #374151;
    --border: #4b5563; --text: #f3f4f6; --text2: #9ca3af;
    --blue: #3b82f6; --green: #10b981; --red: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* Toolbar */
  .toolbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .toolbar-title { font-size: 14px; font-weight: 700; color: var(--text2); }
  .toolbar-title span { color: var(--blue); }
  .toolbar-group { display: flex; gap: 6px; align-items: center; }
  .view-toggle { display: flex; background: var(--bg3); border-radius: 6px; overflow: hidden; }
  .view-btn { padding: 5px 12px; font-size: 12px; border: none; cursor: pointer; color: var(--text2); background: transparent; transition: all 0.2s; }
  .view-btn.active { background: var(--blue); color: white; }
  .btn { padding: 5px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
  .btn-primary { background: var(--blue); color: white; }
  .btn-primary:hover { background: #2563eb; }
  .btn-secondary { background: var(--bg3); color: var(--text2); }
  .btn-secondary:hover { background: #4b5563; }

  /* Layout */
  .main { display: flex; flex: 1; overflow: hidden; }
  .editor-pane { width: 50%; overflow-y: auto; padding: 16px; border-right: 1px solid var(--border); scrollbar-width: thin; }
  .preview-pane { width: 50%; overflow-y: auto; background: #d1d5db; scrollbar-width: thin; }
  .main.editor-only .editor-pane { width: 100%; }
  .main.editor-only .preview-pane { display: none; }
  .main.preview-only .editor-pane { display: none; }
  .main.preview-only .preview-pane { width: 100%; }
  .code-pane { flex: 1; overflow: auto; padding: 16px; }
  .code-pane pre { font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; color: #86efac; background: #030712; padding: 16px; border-radius: 8px; border: 1px solid var(--border); white-space: pre-wrap; line-height: 1.6; }

  /* Editor components */
  .section { margin-bottom: 16px; }
  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .section-title { font-size: 11px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.05em; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
  .field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
  .field-label { font-size: 11px; color: var(--text2); }
  .field-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .field-row .field-label { width: 80px; flex-shrink: 0; }
  input[type="text"], textarea, select { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 8px; color: var(--text); font-size: 13px; width: 100%; outline: none; }
  input[type="text"]:focus, textarea:focus, select:focus { border-color: var(--blue); }
  textarea { resize: none; }
  input[type="number"] { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 8px; color: var(--text); font-size: 13px; outline: none; }
  input[type="number"]:focus { border-color: var(--blue); }
  input[type="color"] { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: transparent; padding: 2px; }
  .color-val { font-size: 11px; color: var(--text2); font-family: monospace; }
  .tabs-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
  .tab-btn { padding: 4px 12px; border-radius: 6px; border: none; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .tab-btn.sel-blue { background: var(--blue); color: white; }
  .tab-btn.sel-green { background: var(--green); color: white; }
  .tab-btn.default { background: var(--bg3); color: var(--text2); }
  .tab-btn.default:hover { background: #4b5563; }
  .small-btn { padding: 2px 8px; border-radius: 4px; border: none; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .small-btn.normal { background: var(--bg3); color: var(--text2); }
  .small-btn.normal:hover { background: #4b5563; }
  .small-btn.danger { background: #7f1d1d; color: #fca5a5; }
  .small-btn.danger:hover { background: #991b1b; }
  .small-btn.add { background: var(--bg3); color: var(--text2); }
  .list-item-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 6px; }
  .list-item-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .list-item-num { font-size: 11px; color: var(--text2); font-family: monospace; }
  .list-item-actions { display: flex; gap: 4px; }
  .empty-msg { font-size: 12px; color: var(--text2); font-style: italic; }

  /* Preview */
  .preview-frame { max-width: 420px; margin: 0 auto; background: #e5e7eb; min-height: 100%; box-shadow: 0 25px 50px rgba(0,0,0,0.3); font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif; }
  .pv-header { display: flex; justify-content: center; align-items: flex-end; padding-bottom: 30px; height: 280px; }
  .pv-title { writing-mode: vertical-rl; letter-spacing: 0.1em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); transition: opacity 0.3s; }
  .pv-main-tabs { display: flex; background: white; border-bottom: 2px solid #e0e0e0; }
  .pv-main-tab { flex: 1; padding: 12px; text-align: center; font-size: 16px; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; background: white; border-top: none; border-left: none; border-right: none; }
  .pv-main-tab:hover { background: #f5f5f5; }
  .pv-subtabs { display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto; background: white; border-bottom: 1px solid #f0f0f0; }
  .pv-subtab { padding: 8px 20px; border-radius: 2px; font-size: 13px; white-space: nowrap; cursor: pointer; transition: all 0.3s; flex-shrink: 0; border: none; font-weight: 500; }
  .pv-content { padding: 16px; background: white; }
  .pv-card { border-radius: 12px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .pv-card-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 6px; }
  .pv-card-text { font-size: 14px; color: #555; line-height: 1.8; }
  .pv-list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
  .pv-list-item:last-child { border-bottom: none; }
  .pv-list-title { font-size: 15px; font-weight: bold; color: #222; margin-bottom: 2px; }
  .pv-list-sub { font-size: 13px; color: #555; }
  .pv-list-arrow { color: #ccc; font-size: 22px; margin-left: 8px; }
  .pv-indicators { display: flex; justify-content: center; padding: 16px; gap: 8px; background: white; }
  .pv-indicator { border-radius: 50%; cursor: pointer; transition: all 0.3s; border: none; height: 8px; }
</style>
</head>
<body>

<div class="toolbar">
  <div class="toolbar-group">
    <div class="toolbar-title"><span>Mobile</span> Page Editor</div>
    <div class="view-toggle">
      <button class="view-btn active" data-view="split">ÂàÜÂâ≤</button>
      <button class="view-btn" data-view="editor">Á∑®ÈõÜ</button>
      <button class="view-btn" data-view="preview">„Éó„É¨„Éì„É•„Éº</button>
      <button class="view-btn" data-view="code">HTML</button>
    </div>
  </div>
  <div class="toolbar-group">
    <button class="btn btn-secondary" id="copyBtn">„Ç≥„Éî„Éº</button>
    <button class="btn btn-primary" id="dlBtn">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
  </div>
</div>

<div class="main" id="mainArea">
  <div class="editor-pane" id="editorPane"></div>
  <div class="preview-pane" id="previewPane"></div>
  <div class="code-pane" id="codePane" style="display:none"><pre id="codeOutput"></pre></div>
</div>

<script>
// ===== DATA =====
let data = {
  header: { 
    title: "„Çø„Ç§„Éà„É´", 
    gradientStart: "#333333", 
    gradientEnd: "#666666", 
    bgAngle: 135,
    titleColor: "#ffffff",
    titleFontSize: 48,
    titleFontWeight: "bold"
  },
  accentColor: "#666666",
  tabs: [
    {
      id: "t0", name: "„Çø„Éñ1", headerTitle: "„Çø„Éñ1„Çø„Ç§„Éà„É´",
      subtabs: [
        { id: "s0", name: "„Çµ„Éñ„Çø„Éñ1", card: { title: "„Ç´„Éº„Éâ„Çø„Ç§„Éà„É´", text: "„Ç´„Éº„Éâ„ÅÆË™¨ÊòéÊñá„Åå„Åì„Åì„Å´ÂÖ•„Çä„Åæ„Åô„ÄÇ", colorStart: "#cccccc", colorEnd: "#aaaaaa" },
          listItems: [{ id: "l0", title: "„É™„Çπ„ÉàÈ†ÖÁõÆ1", subtitle: "2026Âπ¥2Êúà15Êó•", url: "" }, { id: "l1", title: "„É™„Çπ„ÉàÈ†ÖÁõÆ2", subtitle: "2026Âπ¥2Êúà20Êó•", url: "" }] },
        { id: "s1", name: "„Çµ„Éñ„Çø„Éñ2", card: { title: "„Ç´„Éº„Éâ2", text: "Ë™¨ÊòéÊñá2", colorStart: "#d0d0d0", colorEnd: "#b8b8b8" },
          listItems: [{ id: "l2", title: "È†ÖÁõÆ", subtitle: "Ë©≥Á¥∞", url: "" }] }
      ]
    },
    {
      id: "t1", name: "„Çø„Éñ2", headerTitle: "„Çø„Éñ2„Çø„Ç§„Éà„É´",
      subtabs: [
        { id: "s2", name: "„Çµ„Éñ„Çø„Éñ", card: { title: "„Çø„Ç§„Éà„É´", text: "Ë™¨Êòé", colorStart: "#d0d0d0", colorEnd: "#b8b8b8" },
          listItems: [{ id: "l3", title: "TOP3", subtitle: "Èñ≤Ë¶ßÊï∞ 15,234", url: "" }] }
      ]
    },
    {
      id: "t2", name: "„Çø„Éñ3", headerTitle: "„Çø„Éñ3„Çø„Ç§„Éà„É´",
      subtabs: [
        { id: "s3", name: "„Çµ„Éñ„Çø„Éñ", card: { title: "„Çø„Ç§„Éà„É´", text: "Ë™¨ÊòéÊñá", colorStart: "#c8c8c8", colorEnd: "#a0a0a0" },
          listItems: [{ id: "l4", title: "È†ÖÁõÆA", subtitle: "Ë©≥Á¥∞ / Ë£úË∂≥", url: "" }, { id: "l5", title: "È†ÖÁõÆB", subtitle: "Ë©≥Á¥∞ÊÉÖÂ†±", url: "" }] }
      ]
    }
  ]
};

let selTab = 0, selSubtab = 0, pvTab = 0, pvSubtabs = {};
let _uid = 200;
const uid = () => "id_" + (_uid++);

// ===== VIEW TOGGLE =====
let currentView = "split";
document.querySelectorAll(".view-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".view-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentView = btn.dataset.view;
    applyView();
  });
});

function applyView() {
  const m = document.getElementById("mainArea");
  const ep = document.getElementById("editorPane");
  const pp = document.getElementById("previewPane");
  const cp = document.getElementById("codePane");
  m.className = "main";
  ep.style.display = ""; pp.style.display = ""; cp.style.display = "none";
  if (currentView === "split") { /* default */ }
  else if (currentView === "editor") { m.classList.add("editor-only"); }
  else if (currentView === "preview") { m.classList.add("preview-only"); }
  else if (currentView === "code") {
    ep.style.display = "none"; pp.style.display = "none"; cp.style.display = "";
    document.getElementById("codeOutput").textContent = generateHTML();
  }
}

// ===== RENDER EDITOR =====
function renderEditor() {
  const ep = document.getElementById("editorPane");
  let h = "";

  // Header section
  h += `<div class="section">
    <div class="section-header"><div class="section-title">„Éò„ÉÉ„ÉÄ„ÉºË®≠ÂÆö</div></div>
    <div class="field"><div class="field-label">„Çø„Ç§„Éà„É´</div>
      <input type="text" value="${esc(data.header.title)}" onchange="data.header.title=this.value;update()"></div>
    <div class="field-row"><div class="field-label">ÊñáÂ≠óËâ≤</div>
      <input type="color" value="${data.header.titleColor}" onchange="data.header.titleColor=this.value;update()">
      <span class="color-val">${data.header.titleColor}</span></div>
    <div class="field-row"><div class="field-label">„Çµ„Ç§„Ç∫</div>
      <input type="number" value="${data.header.titleFontSize}" min="12" max="120" style="width:70px" onchange="data.header.titleFontSize=parseInt(this.value)||48;update()">
      <span class="color-val">px</span></div>
    <div class="field-row"><div class="field-label">Â§™„Åï</div>
      <select style="width:auto" onchange="data.header.titleFontWeight=this.value;update()">
        <option value="normal" ${data.header.titleFontWeight==='normal'?'selected':''}>ÊôÆÈÄö (normal)</option>
        <option value="bold" ${data.header.titleFontWeight==='bold'?'selected':''}>Â§™Â≠ó (bold)</option>
        <option value="100" ${data.header.titleFontWeight==='100'?'selected':''}>100 (Ê•µÁ¥∞)</option>
        <option value="200" ${data.header.titleFontWeight==='200'?'selected':''}>200</option>
        <option value="300" ${data.header.titleFontWeight==='300'?'selected':''}>300 (Á¥∞„ÇÅ)</option>
        <option value="400" ${data.header.titleFontWeight==='400'?'selected':''}>400 (Ê®ôÊ∫ñ)</option>
        <option value="500" ${data.header.titleFontWeight==='500'?'selected':''}>500 (‰∏≠)</option>
        <option value="600" ${data.header.titleFontWeight==='600'?'selected':''}>600 („ÇÑ„ÇÑÂ§™)</option>
        <option value="700" ${data.header.titleFontWeight==='700'?'selected':''}>700 (Â§™„ÇÅ)</option>
        <option value="800" ${data.header.titleFontWeight==='800'?'selected':''}>800</option>
        <option value="900" ${data.header.titleFontWeight==='900'?'selected':''}>900 (Ê•µÂ§™)</option>
      </select></div>
    <div class="field-row"><div class="field-label">ËÉåÊôØÈñãÂßãËâ≤</div>
      <input type="color" value="${data.header.gradientStart}" onchange="data.header.gradientStart=this.value;update()">
      <span class="color-val">${data.header.gradientStart}</span></div>
    <div class="field-row"><div class="field-label">ËÉåÊôØÁµÇ‰∫ÜËâ≤</div>
      <input type="color" value="${data.header.gradientEnd}" onchange="data.header.gradientEnd=this.value;update()">
      <span class="color-val">${data.header.gradientEnd}</span></div>
    <div class="field-row"><div class="field-label">„Ç¢„ÇØ„Çª„É≥„ÉàËâ≤</div>
      <input type="color" value="${data.accentColor}" onchange="data.accentColor=this.value;update()">
      <span class="color-val">${data.accentColor}</span></div>
  </div><hr class="divider">`;

  // Main tabs
  h += `<div class="section">
    <div class="section-header"><div class="section-title">„É°„Ç§„É≥„Çø„Éñ</div>
      <button class="small-btn add" onclick="addTab()">+ ËøΩÂä†</button></div>
    <div class="tabs-row">${data.tabs.map((t, i) =>
      `<button class="tab-btn ${i === selTab ? 'sel-blue' : 'default'}" onclick="selTab=${i};selSubtab=0;update()">${esc(t.name)}</button>`
    ).join("")}</div></div>`;

  const tab = data.tabs[selTab];
  if (tab) {
    h += `<div class="section">
      <div class="section-header"><div class="section-title">${esc(tab.name)} „ÅÆË®≠ÂÆö</div>
        ${data.tabs.length > 1 ? `<button class="small-btn danger" onclick="removeTab(${selTab})">ÂâäÈô§</button>` : ""}</div>
      <div class="field"><div class="field-label">„Çø„ÉñÂêç</div>
        <input type="text" value="${esc(tab.name)}" onchange="data.tabs[${selTab}].name=this.value;update()"></div>
      <div class="field"><div class="field-label">„Éò„ÉÉ„ÉÄ„Éº„Çø„Ç§„Éà„É´</div>
        <input type="text" value="${esc(tab.headerTitle)}" onchange="data.tabs[${selTab}].headerTitle=this.value;update()"></div>
    </div><hr class="divider">`;

    // Subtabs
    h += `<div class="section">
      <div class="section-header"><div class="section-title">„Çµ„Éñ„Çø„Éñ</div>
        <button class="small-btn add" onclick="addSubtab(${selTab})">+ ËøΩÂä†</button></div>
      <div class="tabs-row">${tab.subtabs.map((st, i) =>
        `<button class="tab-btn ${i === selSubtab ? 'sel-green' : 'default'}" onclick="selSubtab=${i};update()">${esc(st.name)}</button>`
      ).join("")}</div></div>`;

    const st = tab.subtabs[selSubtab];
    if (st) {
      h += `<div class="section">
        <div class="section-header"><div class="section-title">${esc(st.name)} „ÅÆË®≠ÂÆö</div>
          ${tab.subtabs.length > 1 ? `<button class="small-btn danger" onclick="removeSubtab(${selTab},${selSubtab})">ÂâäÈô§</button>` : ""}</div>
        <div class="field"><div class="field-label">„Çµ„Éñ„Çø„ÉñÂêç</div>
          <input type="text" value="${esc(st.name)}" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].name=this.value;update()"></div>
      </div><hr class="divider">`;

      // Card
      h += `<div class="section">
        <div class="section-header"><div class="section-title">„Ç´„Éº„ÉâË®≠ÂÆö</div></div>
        <div class="field"><div class="field-label">„Ç´„Éº„Éâ„Çø„Ç§„Éà„É´</div>
          <input type="text" value="${esc(st.card.title)}" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].card.title=this.value;update()"></div>
        <div class="field"><div class="field-label">„Ç´„Éº„ÉâË™¨ÊòéÊñá</div>
          <textarea rows="2" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].card.text=this.value;update()">${esc(st.card.text)}</textarea></div>
        <div class="field-row"><div class="field-label">„Ç´„Éº„ÉâÈñãÂßãËâ≤</div>
          <input type="color" value="${st.card.colorStart}" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].card.colorStart=this.value;update()">
          <span class="color-val">${st.card.colorStart}</span></div>
        <div class="field-row"><div class="field-label">„Ç´„Éº„ÉâÁµÇ‰∫ÜËâ≤</div>
          <input type="color" value="${st.card.colorEnd}" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].card.colorEnd=this.value;update()">
          <span class="color-val">${st.card.colorEnd}</span></div>
      </div><hr class="divider">`;

      // List items
      h += `<div class="section">
        <div class="section-header"><div class="section-title">„É™„Çπ„ÉàÈ†ÖÁõÆ</div>
          <button class="small-btn add" onclick="addListItem(${selTab},${selSubtab})">+ ËøΩÂä†</button></div>`;
      if (st.listItems.length === 0) {
        h += `<div class="empty-msg">„É™„Çπ„ÉàÈ†ÖÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
      }
      st.listItems.forEach((item, li) => {
        h += `<div class="list-item-card">
          <div class="list-item-header">
            <span class="list-item-num">#${li + 1}</span>
            <div class="list-item-actions">
              <button class="small-btn normal" onclick="moveItem(${selTab},${selSubtab},${li},-1)">‚Üë</button>
              <button class="small-btn normal" onclick="moveItem(${selTab},${selSubtab},${li},1)">‚Üì</button>
              <button class="small-btn danger" onclick="removeListItem(${selTab},${selSubtab},${li})">ÂâäÈô§</button>
            </div>
          </div>
          <div class="field"><div class="field-label">„Çø„Ç§„Éà„É´</div>
            <input type="text" value="${esc(item.title)}" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].listItems[${li}].title=this.value;update()"></div>
          <div class="field"><div class="field-label">„Çµ„Éñ„Çø„Ç§„Éà„É´</div>
            <input type="text" value="${esc(item.subtitle)}" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].listItems[${li}].subtitle=this.value;update()"></div>
          <div class="field"><div class="field-label">URL</div>
            <div style="display:flex;gap:6px;align-items:center">
              <input type="text" value="${esc(item.url||'')}" placeholder="https://example.com" onchange="data.tabs[${selTab}].subtabs[${selSubtab}].listItems[${li}].url=this.value;update()" style="flex:1">
              ${item.url ? '<span style="color:#10b981;font-size:11px">‚úì „É™„É≥„ÇØË®≠ÂÆöÊ∏à</span>' : ''}
            </div></div>
        </div>`;
      });
      h += `</div>`;
    }
  }
  ep.innerHTML = h;
}

// ===== RENDER PREVIEW =====
function renderPreview() {
  const pp = document.getElementById("previewPane");
  const tab = data.tabs[pvTab];
  const accent = data.accentColor;
  const pvSt = pvSubtabs[pvTab] || 0;

  let h = `<div class="preview-frame">`;
  // Header with dynamic title styles
  h += `<div class="pv-header" style="background:linear-gradient(${data.header.bgAngle}deg,${data.header.gradientStart},${data.header.gradientEnd})">
    <div class="pv-title" style="color:${data.header.titleColor};font-size:${data.header.titleFontSize}px;font-weight:${data.header.titleFontWeight}">${esc(tab ? tab.headerTitle : data.header.title)}</div></div>`;
  // Main tabs
  h += `<div class="pv-main-tabs">${data.tabs.map((t, i) =>
    `<button class="pv-main-tab" style="border-bottom-color:${i === pvTab ? accent : 'transparent'};color:${i === pvTab ? accent : '#999'};background:${i === pvTab ? '#f9f9ff' : 'white'}" onclick="pvTab=${i};update()">${esc(t.name)}</button>`
  ).join("")}</div>`;

  if (tab) {
    const st = tab.subtabs[pvSt];
    // Subtabs
    h += `<div class="pv-subtabs">${tab.subtabs.map((s, i) =>
      `<button class="pv-subtab" style="background:${i === pvSt ? accent : '#f0f0f0'};color:${i === pvSt ? 'white' : '#666'};${i === pvSt ? 'box-shadow:0 2px 8px ' + accent + '4d' : ''}" onclick="pvSubtabs[${pvTab}]=${i};update()">${esc(s.name)}</button>`
    ).join("")}</div>`;

    if (st) {
      h += `<div class="pv-content">
        <div class="pv-card" style="background:linear-gradient(135deg,${st.card.colorStart},${st.card.colorEnd})">
          <div class="pv-card-title">${esc(st.card.title)}</div>
          <div class="pv-card-text">${esc(st.card.text)}</div></div>
        <div>`;
      st.listItems.forEach((item, i) => {
        const hasUrl = item.url && item.url.trim();
        h += `<div class="pv-list-item" style="${i < st.listItems.length - 1 ? 'border-bottom:1px solid #f0f0f0;' : ''}${hasUrl ? 'cursor:pointer;' : ''}">
          <div style="flex:1"><div class="pv-list-title">${esc(item.title)}${hasUrl ? ' <span style="font-size:12px;color:#3b82f6">üîó</span>' : ''}</div><div class="pv-list-sub">${esc(item.subtitle)}</div></div>
          <span class="pv-list-arrow">‚Ä∫</span></div>`;
      });
      h += `</div></div>`;
    }

    // Indicators
    h += `<div class="pv-indicators">${data.tabs.map((_, i) =>
      `<button class="pv-indicator" style="width:${i === pvTab ? '24px' : '8px'};background:${i === pvTab ? accent : '#ddd'};border-radius:${i === pvTab ? '4px' : '50%'}" onclick="pvTab=${i};update()"></button>`
    ).join("")}</div>`;
  }
  h += `</div>`;
  pp.innerHTML = h;
}

// ===== DATA OPERATIONS =====
function addTab() {
  data.tabs.push({ id: uid(), name: "„Çø„Éñ" + (data.tabs.length + 1), headerTitle: "Êñ∞„Åó„ÅÑ„Çø„Éñ",
    subtabs: [{ id: uid(), name: "„Çµ„Éñ„Çø„Éñ", card: { title: "„Çø„Ç§„Éà„É´", text: "Ë™¨ÊòéÊñá", colorStart: "#cccccc", colorEnd: "#aaaaaa" }, listItems: [] }] });
  update();
}
function removeTab(i) {
  if (data.tabs.length <= 1) return;
  data.tabs.splice(i, 1);
  if (selTab >= data.tabs.length) selTab = data.tabs.length - 1;
  selSubtab = 0;
  if (pvTab >= data.tabs.length) pvTab = data.tabs.length - 1;
  update();
}
function addSubtab(ti) {
  data.tabs[ti].subtabs.push({ id: uid(), name: "Êñ∞Ë¶è„Çµ„Éñ„Çø„Éñ", card: { title: "„Çø„Ç§„Éà„É´", text: "Ë™¨ÊòéÊñá", colorStart: "#d0d0d0", colorEnd: "#b0b0b0" }, listItems: [] });
  update();
}
function removeSubtab(ti, si) {
  if (data.tabs[ti].subtabs.length <= 1) return;
  data.tabs[ti].subtabs.splice(si, 1);
  if (selSubtab >= data.tabs[ti].subtabs.length) selSubtab = data.tabs[ti].subtabs.length - 1;
  update();
}
function addListItem(ti, si) {
  data.tabs[ti].subtabs[si].listItems.push({ id: uid(), title: "Êñ∞Ë¶èÈ†ÖÁõÆ", subtitle: "Ë©≥Á¥∞", url: "" });
  update();
}
function removeListItem(ti, si, li) {
  data.tabs[ti].subtabs[si].listItems.splice(li, 1);
  update();
}
function moveItem(ti, si, li, dir) {
  const items = data.tabs[ti].subtabs[si].listItems;
  const ni = li + dir;
  if (ni < 0 || ni >= items.length) return;
  [items[li], items[ni]] = [items[ni], items[li]];
  update();
}

function esc(s) { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

function update() {
  renderEditor();
  renderPreview();
  if (currentView === "code") {
    document.getElementById("codeOutput").textContent = generateHTML();
  }
}

// ===== GENERATE HTML =====
function generateHTML() {
  const accent = data.accentColor;
  const titleColor = data.header.titleColor;
  const titleFontSize = data.header.titleFontSize;
  const titleFontWeight = data.header.titleFontWeight;
  
  const tabsHTML = data.tabs.map((tab, i) =>
    `<div class="main-tab${i===0?' active':''}" data-tab="${i}" data-title="${esc(tab.headerTitle)}">${esc(tab.name)}</div>`
  ).join("\n        ");

  const slidesHTML = data.tabs.map((tab, ti) => {
    const stHTML = tab.subtabs.map((st, si) =>
      `<div class="subtab${si===0?' active':''}" data-slide="${ti}" data-subtab="${si}">${esc(st.name)}</div>`
    ).join("\n                    ");
    const cHTML = tab.subtabs.map((st, si) => {
      const items = st.listItems.map(item => {
        const hasUrl = item.url && item.url.trim();
        const inner = `
                                <div class="list-content">
                                    <div class="list-title">${esc(item.title)}</div>
                                    <div class="list-subtitle">${esc(item.subtitle)}</div>
                                </div>
                                <div class="list-arrow">‚Ä∫</div>`;
        if (hasUrl) {
          return `
                            <a href="${esc(item.url.trim())}" target="_blank" rel="noopener noreferrer" class="content-list-item" style="text-decoration:none;color:inherit;display:flex;align-items:center;">${inner}
                            </a>`;
        }
        return `
                            <div class="content-list-item">${inner}
                            </div>`;
      }).join("");
      return `
                    <div class="subtab-content${si===0?' active':''}" data-slide="${ti}" data-content="${si}">
                        <div class="content-card" style="background:linear-gradient(135deg,${st.card.colorStart} 0%,${st.card.colorEnd} 100%);">
                            <div class="content-card-title">${esc(st.card.title)}</div>
                            <div class="content-card-text">${esc(st.card.text)}</div>
                        </div>
                        <div class="content-list">${items}
                        </div>
                    </div>`;
    }).join("");
    return `
            <div class="carousel-slide${ti===0?' active':''}">
                <div class="subtabs-container" id="subtabs-${ti}">
                    ${stHTML}
                </div>
                <div class="subtab-content-wrapper">${cHTML}
                </div>
            </div>`;
  }).join("");

  const indHTML = data.tabs.map((_, i) =>
    `<div class="indicator${i===0?' active':''}" data-slide="${i}"></div>`
  ).join("\n            ");

  // Calculate responsive font sizes based on the editor setting
  const mobileFontSize = Math.round(titleFontSize * 1.25);
  const tabletFontSize = Math.round(titleFontSize * 1.875);
  const desktopFontSize = Math.round(titleFontSize * 2.5);

  return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¢„Éê„Ç§„É´„Éö„Éº„Ç∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif; background-color: #e8e8e8; max-width: 100%; overflow-x: hidden; }
        @media (min-width: 768px) { body { display: flex; flex-direction: column; align-items: center; } .header-grid, .main-tabs-container, .carousel-container { max-width: 768px; } .header-grid { width: 768px; } }
        .header-grid { width: 100vw; height: 75vw; background: linear-gradient(${data.header.bgAngle}deg, ${data.header.gradientStart} 0%, ${data.header.gradientEnd} 100%); display: flex; justify-content: center; align-items: flex-end; padding-bottom: 30px; position: relative; }
        .vertical-title { writing-mode: vertical-rl; font-size: ${mobileFontSize}px; color: ${titleColor}; font-weight: ${titleFontWeight}; letter-spacing: 0.1em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); transition: opacity 0.3s ease; }
        @media (min-width: 768px) { .vertical-title { font-size: ${tabletFontSize}px; } }
        @media (min-width: 1024px) { .vertical-title { font-size: ${desktopFontSize}px; } .header-grid { height: 60vw; max-height: 600px; } }
        .main-tabs-container { display: flex; background-color: white; border-bottom: 2px solid #e0e0e0; }
        .main-tab { flex: 1; padding: 16px; text-align: center; font-size: 32px; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; background-color: white; }
        .main-tab.active { color: ${accent}; border-bottom-color: ${accent}; background-color: #f9f9ff; }
        .main-tab:hover { background-color: #f5f5f5; }
        .carousel-container { position: relative; background-color: white; }
        .carousel-wrapper { display: flex; }
        .carousel-slide { min-width: 100%; display: none; }
        .carousel-slide.active { display: block; }
        .subtabs-container { display: flex; background: white; padding: 16px 20px; gap: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; border-bottom: 1px solid #f0f0f0; }
        .subtabs-container::-webkit-scrollbar { display: none; }
        .subtab { padding: 20px 48px; border-radius: 0px; background: #f0f0f0; color: #666; font-size: 28px; white-space: nowrap; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0; }
        .subtab.active { background: ${accent}; color: white; box-shadow: 0 2px 8px ${accent}4d; }
        .subtab:active { transform: scale(0.95); }
        .subtab-content-wrapper { background: white; }
        .subtab-content { display: none; padding: 24px 20px; animation: fadeIn 0.3s ease; }
        .subtab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .content-card { border-radius: 12px; padding: 30px 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .content-card-title { font-size: 40px; font-weight: bold; color: #333; margin-bottom: 12px; }
        .content-card-text { font-size: 30px; color: #555; line-height: 1.8; }
        .content-list { background: white; }
        .content-list-item { display: flex; align-items: center; padding: 16px 0; border-bottom: 1px solid #f0f0f0; }
        .content-list-item:last-child { border-bottom: none; }
        a.content-list-item:hover { background-color: #f8f8f8; }
        .list-content { flex: 1; }
        .list-title { font-size: 36px; font-weight: bold; color: #222; margin-bottom: 4px; }
        .list-subtitle { font-size: 30px; color: #555; }
        .list-arrow { color: #ccc; font-size: 48px; margin-left: 8px; }
        .carousel-indicators { display: flex; justify-content: center; padding: 20px; gap: 10px; background: white; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #ddd; cursor: pointer; transition: all 0.3s ease; }
        .indicator.active { background-color: ${accent}; width: 30px; border-radius: 5px; }
        .carousel-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255,255,255,0.95); border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 12px rgba(0,0,0,0.15); z-index: 10; transition: all 0.2s; }
        .carousel-nav:active { transform: translateY(-50%) scale(0.9); }
        .carousel-nav.prev { left: 10px; }
        .carousel-nav.next { right: 10px; }
    </style>
</head>
<body>
    <div class="header-grid">
        <h1 class="vertical-title" id="main-title">${esc(data.header.title)}</h1>
    </div>
    <div class="main-tabs-container">
        ${tabsHTML}
    </div>
    <div class="carousel-container">
        <button class="carousel-nav prev" onclick="changeMainSlide(-1)">‚Äπ</button>
        <button class="carousel-nav next" onclick="changeMainSlide(1)">‚Ä∫</button>
        <div class="carousel-wrapper">${slidesHTML}
        </div>
        <div class="carousel-indicators">
            ${indHTML}
        </div>
    </div>
    <script>
        let currentMainSlide = 0;
        const mainSlides = document.querySelectorAll('.carousel-slide');
        const mainTabs = document.querySelectorAll('.main-tab');
        const indicators = document.querySelectorAll('.indicator');
        const currentSubTabs = [${data.tabs.map(() => "0").join(", ")}];
        mainTabs.forEach((tab, index) => { tab.addEventListener('click', () => goToMainSlide(index)); });
        indicators.forEach((ind, index) => { ind.addEventListener('click', () => goToMainSlide(index)); });
        document.querySelectorAll('.subtab').forEach(subtab => {
            subtab.addEventListener('click', function() { goToSubTab(parseInt(this.dataset.slide), parseInt(this.dataset.subtab)); });
        });
        function changeMainSlide(direction) { let n = currentMainSlide + direction; if (n < 0) n = mainSlides.length - 1; if (n >= mainSlides.length) n = 0; goToMainSlide(n); }
        function goToMainSlide(index) {
            mainSlides[currentMainSlide].classList.remove('active'); mainTabs[currentMainSlide].classList.remove('active'); indicators[currentMainSlide].classList.remove('active');
            currentMainSlide = index; mainSlides[index].classList.add('active'); mainTabs[index].classList.add('active'); indicators[index].classList.add('active');
            const mainTitle = document.getElementById('main-title'); mainTitle.style.opacity = '0';
            setTimeout(() => { mainTitle.textContent = mainTabs[index].dataset.title; mainTitle.style.opacity = '1'; }, 300);
        }
        function goToSubTab(slideIndex, subtabIndex) {
            const subtabs = document.querySelectorAll('.subtab[data-slide="' + slideIndex + '"]');
            const contents = document.querySelectorAll('.subtab-content[data-slide="' + slideIndex + '"]');
            subtabs[currentSubTabs[slideIndex]].classList.remove('active'); contents[currentSubTabs[slideIndex]].classList.remove('active');
            currentSubTabs[slideIndex] = subtabIndex; subtabs[subtabIndex].classList.add('active'); contents[subtabIndex].classList.add('active');
            const container = document.getElementById('subtabs-' + slideIndex); const active = subtabs[subtabIndex];
            container.scrollTo({ left: active.offsetLeft - container.offsetWidth / 2 + active.offsetWidth / 2, behavior: 'smooth' });
        }
        let touchStartX = 0, touchEndX = 0;
        const cc = document.querySelector('.carousel-container');
        cc.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
        cc.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; const diff = touchEndX - touchStartX; if (diff < -50) changeMainSlide(1); if (diff > 50) changeMainSlide(-1); });
    <\\/script>
</body>
</html>`;
}

// ===== EXPORT =====
document.getElementById("dlBtn").addEventListener("click", () => {
  const html = generateHTML().replace('<\\/script>', '</' + 'script>');
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mobile_page.html";
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById("copyBtn").addEventListener("click", () => {
  const html = generateHTML().replace('<\\/script>', '</' + 'script>');
  navigator.clipboard.writeText(html).then(() => {
    const btn = document.getElementById("copyBtn");
    btn.textContent = "‚úì „Ç≥„Éî„ÉºÂÆå‰∫Ü";
    setTimeout(() => btn.textContent = "„Ç≥„Éî„Éº", 2000);
  });
});

// Initial render
update();
</script>
</body>
</html>
